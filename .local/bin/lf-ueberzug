#!/bin/sh
set -euf

is_sourced() {
  if [ -n "${BASH_VERSION-}" ]; then
    case "${BASH_SOURCE[0]}" in
      "$0") return 1 ;;
      *) return 0 ;;
    esac
  fi
  if [ -n "${ZSH_VERSION-}" ]; then
    case "${ZSH_EVAL_CONTEXT-}" in (*:file) return 0 ;; esac
    return 1
  fi
  return 1
}

if is_sourced; then
  lf-ueberzug() {
    if [ -n "${DISPLAY-}" ] && [ -z "${FIFO_UEBERZUG-}" ]; then
      export FIFO_UEBERZUG="${TMPDIR:-/tmp}/lf-ueberzug-$$"

      cleanup() {
        exec 3>&-
        rm -- "$FIFO_UEBERZUG"
      }

      mkfifo -- "$FIFO_UEBERZUG"
      while [ -p "$FIFO_UEBERZUG" ] && ! ueberzug layer -s <"$FIFO_UEBERZUG"; do :; done &
      exec 3>"$FIFO_UEBERZUG"
      trap cleanup EXIT

      command lf "$@" 3>&-
    else
      command lf "$@"
    fi
  }

  lf() {
    local pane_id=$(tmux display-message -p '#{pane_id}' 2>/dev/null)
    if [ -n "$pane_id" ]; then
      export LF_TMUX_PANE="$pane_id"
    fi
    cd "$(lf-ueberzug -print-last-dir "$@")"
    unset LF_TMUX_PANE 2>/dev/null
  }

  return 0
fi

if [ -n "${DISPLAY-}" ] && [ -z "${FIFO_UEBERZUG-}" ]; then
  export FIFO_UEBERZUG="${TMPDIR:-/tmp}/lf-ueberzug-$$"

  cleanup() {
    exec 3>&-
    rm -- "$FIFO_UEBERZUG"
  }

  mkfifo -- "$FIFO_UEBERZUG"
  while [ -p "$FIFO_UEBERZUG" ] && ! ueberzug layer -s <"$FIFO_UEBERZUG"; do :; done &
  exec 3>"$FIFO_UEBERZUG"
  trap cleanup EXIT

  lf "$@" 3>&-
else
  exec lf "$@"
fi

