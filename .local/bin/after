#!/bin/bash

if [ "$#" -lt 2 ]; then
    echo "Usage: $0 <process_name> <command_to_run> [args...]"
    exit 1
fi

process_name="$1"
shift
command_to_run=("$@")

echo "Waiting for main '$process_name' process to finish..."

# Get the youngest parent process matching the name
get_main_pid() {
    # Get all PIDs, find their parent PIDs, pick the youngest (highest PID)
    pgrep -f "$process_name" | while read pid; do
        # Check if this is a parent process (no other matching process is its parent)
        ppid=$(ps -o ppid= -p "$pid" 2>/dev/null | tr -d ' ')
        if ! pgrep -f "$process_name" | grep -q "^$ppid$"; then
            echo "$pid"
        fi
    done | tail -1  # Get the youngest (last/highest PID)
}

while true; do
    main_pid=$(get_main_pid)
    if [ -n "$main_pid" ] && ps -p "$main_pid" > /dev/null 2>&1; then
        sleep 1
    else
        break
    fi
done

echo "'$process_name' finished. Running your command..."
"${command_to_run[@]}"
