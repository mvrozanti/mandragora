#!/bin/sh

file="$1"
[ -z "$file" ] && exit 1

mime=$(file --mime-type -Lb -- "$file")

case "$mime" in
       image/*)
        # Get directory and filename
        dir=$(dirname -- "$file")
        current=$(basename -- "$file")
        
        # Change to the image's directory
        cd -- "$dir" || exit 1
        
        # 1. Get ALL image files in directory, sorted by modification time (newest first)
        #    This matches LF's default 'ctime reverse' sorting
        img_files=$(ls -1t -- *.jpg *.jpeg *.png *.gif *.bmp *.tiff *.webp 2>/dev/null)
        
        # 2. If no files found, fallback to just the current file
        if [ -z "$img_files" ]; then
            setsid sxiv -- "$current" >/dev/null 2>&1 &
            exit 0
        fi
        
        # 3. Find the position of the current file in the list
        index=0
        counter=0
        for f in $img_files; do
            if [ "$f" = "$current" ]; then
                index=$counter
                break
            fi
            counter=$((counter + 1))
        done
        
        # 4. Launch sxiv with ALL images, starting at the current file
        eval "setsid sxiv -n $index -- $img_files" >/dev/null 2>&1 &
        ;; 
    # Keep your existing cases for other file types
    video/*|audio/*)
        setsid mpv -- "$file" >/dev/null 2>&1 &
        ;;
    
    application/pdf|application/epub+zip)
        setsid zathura -- "$file" >/dev/null 2>&1 &
        ;;
    
    text/*)
        nvim "$file"
        ;;
    
    application/zip|application/x-tar|application/x-7z-compressed|application/x-rar)
        atool --list -- "$file" | ${PAGER:-less}
        ;;
    
    *)
        setsid xdg-open -- "$file" >/dev/null 2>&1 &
        ;;
esac
