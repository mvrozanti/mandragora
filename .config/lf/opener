#!/bin/sh

file="$1"
[ -z "$file" ] && exit 1

mime=$(file --mime-type -Lb -- "$file")

case "$mime" in
    image/*)
        # Get directory and filename
        dir=$(dirname -- "$file")
        current="$file"
        
        # Check if we're being called from lf (has $id env var)
        if [ -n "$id" ] && command -v lf >/dev/null 2>&1; then
            # Get fresh file list in display order from lf
            files=$(lf -remote "query $id files-fresh" 2>/dev/null)
            
            if [ -n "$files" ]; then
                # Filter for image files only
                image_files=$(echo "$files" | grep -iE '\.(jpg|jpeg|png|gif|bmp|tiff|tif|svg|webp|xpm|ico)$')
                
                # Find index of current file in the filtered list (1-based for sxiv)
                index=$(echo "$image_files" | grep -nFx "$current" | cut -d: -f1)
                
                # Launch sxiv with images via stdin, starting at current file
                if [ -n "$index" ] && [ -n "$image_files" ]; then
                    echo "$image_files" | setsid sxiv -ba -n "$index" -i >/dev/null 2>&1 &
                    exit 0
                fi
            fi
        fi
        
        # Fallback: if not in lf context or query failed, use directory-based approach
        cd -- "$dir" || exit 1
        img_files=$(ls -1t -- *.jpg *.jpeg *.png *.gif *.bmp *.tiff *.webp 2>/dev/null | head -100)
        if [ -z "$img_files" ]; then
            setsid sxiv -ba -- "$current" >/dev/null 2>&1 &
            exit 0
        fi
        
        index=0
        counter=0
        for f in $img_files; do
            if [ "$(basename -- "$f")" = "$(basename -- "$current")" ]; then
                index=$counter
                break
            fi
            counter=$((counter + 1))
        done
        
        eval "setsid sxiv -ba -n $index -- $img_files" >/dev/null 2>&1 &
        ;; 
    video/*|audio/*)
        setsid mpv -- "$file" >/dev/null 2>&1 &
        ;;
    
    application/pdf|application/epub+zip)
        setsid zathura -- "$file" >/dev/null 2>&1 &
        ;;
    
    text/*)
        nvim "$file"
        ;;
    
    application/zip|application/x-tar|application/x-7z-compressed|application/x-rar)
        atool --list -- "$file" | ${PAGER:-less}
        ;;
    
    *)
        setsid xdg-open -- "$file" >/dev/null 2>&1 &
        ;;
esac
